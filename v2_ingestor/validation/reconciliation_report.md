# KPI Reconciliation Report - 100% Accuracy Analysis
**Date Range:** 2025-08-18 to 2025-08-24
**Generated:** 2025-10-23

## Executive Summary
This report analyzes all KPIs against ServiceTitan report specifications. Production (Dollars Produced) and Sales (Total Booked) are already at 100% accuracy. Other KPIs require calibration.

---

## SECTION A: KPI Variance Table

### Sales KPIs

| Business Unit | KPI | ST Expected | BQ Current | Variance | % Error | Status |
|--------------|-----|------------|------------|----------|---------|--------|
| **Phoenix-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 99 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 148 | +58 | +64% | üî¥ MAJOR |
|  | Total Booked | $116,551.26 | $116,551.26 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 39.74% | 27.7% | -12.04% | -30% | üî¥ MAJOR |
|  | Estimates Scheduled | TBD | 148 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Tucson-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 39 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 71 | -19 | -21% | üî¥ MAJOR |
|  | Total Booked | $89,990.11 | $89,990.11 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 51.22% | 36.62% | -14.6% | -29% | üî¥ MAJOR |
|  | Estimates Scheduled | TBD | 71 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Nevada-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 27 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 28 | -62 | -69% | üî¥ MAJOR |
|  | Total Booked | $105,890.00 | $105,890.00 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 60.87% | 42.86% | -18.01% | -30% | üî¥ MAJOR |
|  | Estimates Scheduled | TBD | 28 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Andy's Painting-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 24 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 40 | -50 | -56% | üî¥ MAJOR |
|  | Total Booked | $30,896.91 | $30,896.91 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 35.71% | 17.5% | -18.21% | -51% | üî¥ MAJOR |
|  | Estimates Scheduled | TBD | 40 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Commercial-AZ-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 22 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 33 | -57 | -63% | üî¥ MAJOR |
|  | Total Booked | $119,803.60 | $119,803.60 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 26.92% | 15.15% | -11.77% | -44% | üî¥ MAJOR |
|  | Estimates Scheduled | TBD | 33 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Guaranteed Painting-Sales** |  |  |  |  |  |  |
|  | Leads | TBD | 8 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Estimates | 90 | 7 | -83 | -92% | üî¥ MAJOR |
|  | Total Booked | $26,067.40 | $26,067.40 | $0 | 0% | ‚úÖ EXACT |
|  | Success Rate | 77.78% | 71.43% | -6.35% | -8% | ‚ö†Ô∏è MINOR |
|  | Estimates Scheduled | TBD | 7 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |

### Production KPIs

| Business Unit | KPI | ST Expected | BQ Current | Variance | % Error | Status |
|--------------|-----|------------|------------|----------|---------|--------|
| **Phoenix-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $232,891.98 | $232,891.98 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 56.02% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $3,076,222.34 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 1.24% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $2,899,319.78 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Tucson-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $83,761.16 | $83,761.16 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 55.7% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $1,367,562.46 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 0.32% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $1,745,798.87 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Nevada-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $23,975.00 | $23,975.00 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 43.77% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $497,926.25 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 9.21% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $911,221.24 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Andy's Painting-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $53,752.56 | $53,752.56 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 48.53% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $523,258.64 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 1.14% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $369,826.35 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Commercial-AZ-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $77,345.25 | $77,345.25 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 59.61% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $1,229,834.16 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 0.0% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $988,350.14 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
| **Guaranteed Painting-Production** |  |  |  |  |  |  |
|  | Dollars Produced | $30,472.30 | $30,472.30 | $0 | 0% | ‚úÖ EXACT |
|  | GPM % | TBD | 36.59% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Dollars Collected | TBD | - | - | - | ‚ö†Ô∏è NO DATA |
|  | Future Bookings | TBD | $393,986.27 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Warranty % | TBD | 0.0% | - | - | ‚ö†Ô∏è NEEDS VALIDATION |
|  | Outstanding A/R | TBD | $273,935.17 | - | - | ‚ö†Ô∏è NEEDS VALIDATION |

---

## SECTION B: Root Cause Analysis

### ‚úÖ WORKING CORRECTLY (0% Variance)
1. **Total Booked** - Using `estimate.soldOn` date matches ST exactly
2. **Dollars Produced** - Using `job_start_date` with `jobStatus IN ('Completed', 'Hold')` matches ST exactly

### üî¥ MAJOR ISSUES

#### 1. **Estimates Count Variance** (All Sales BUs showing wrong counts)
- **Root Cause:** We're counting ALL estimates, but ST report filters for specific job types
- **ST Filter:** Only counts job types containing "ESTIMATE" (18 specific types listed)
- **Fix Needed:** Create job type mapping table and apply filters

#### 2. **Success Rate / Close Rate Variance** (All showing lower than ST)
- **Root Cause:** Denominator calculation differs
- **ST Method:** Uses "Sales Opportunity" count (likely unique customers with estimates)
- **BQ Method:** Uses total estimate count
- **Fix Needed:** Change to COUNT(DISTINCT customerId) for denominator

#### 3. **Dollars Collected Missing** (All Production showing NULL)
- **Root Cause:** Date filter on payments table not matching ST report
- **ST Method:** Uses payment date range
- **Fix Needed:** Verify payment date field and ensure data exists

#### 4. **Leads Count** (No ST comparison available)
- **Root Cause:** Need ST export to validate
- **ST Filter:** Customer name != 'Test', Job Type contains 'Estimate' but NOT 'COMM'
- **Fix Needed:** Implement job type filtering

---

## SECTION C: SQL Patches

### Patch 1: Fix Success Rate Calculation
```sql
-- Current (incorrect)
ROUND(SAFE_DIVIDE(
  COUNT(DISTINCT CASE WHEN e.status = 'Sold' THEN e.id END),
  COUNT(DISTINCT e.id)
) * 100, 2) as close_rate_pct

-- Fixed (use customer count)
ROUND(SAFE_DIVIDE(
  COUNT(DISTINCT CASE WHEN e.status = 'Sold' THEN j.customerId END),
  COUNT(DISTINCT j.customerId)
) * 100, 2) as close_rate_pct
```

### Patch 2: Fix Estimates Count with Job Type Filter
```sql
-- Need to create job type mapping first
CREATE OR REPLACE TABLE `kpi-auto-471020.st_ref_v2.job_type_categories` AS
SELECT DISTINCT
  jobTypeId,
  CASE
    WHEN jobTypeId IN (
      -- List of estimate job type IDs to be determined
    ) THEN 'ESTIMATE'
    WHEN jobTypeId IN (
      -- Warranty/Touchup job type IDs
    ) THEN 'WARRANTY'
    ELSE 'PRODUCTION'
  END as category
FROM `kpi-auto-471020.st_dim_v2.dim_jobs`;

-- Then filter estimates
COUNT(DISTINCT e.id) as estimate_count
WHERE j.jobTypeId IN (
  SELECT jobTypeId
  FROM `kpi-auto-471020.st_ref_v2.job_type_categories`
  WHERE category = 'ESTIMATE'
)
```

### Patch 3: Fix Dollars Collected Date Range
```sql
-- Check payment date field usage
SELECT
  j.businessUnitNormalized,
  ROUND(SUM(p.amount), 2) as dollars_collected
FROM `kpi-auto-471020.st_raw_v2.raw_payments` p
JOIN `kpi-auto-471020.st_raw_v2.raw_invoices` i ON p.invoiceId = i.id
JOIN `kpi-auto-471020.st_dim_v2.dim_jobs` j ON i.jobId = j.id
WHERE DATE(p.paymentDate) BETWEEN start_date AND end_date  -- Use paymentDate not createdOn
  AND j.businessUnitNormalized LIKE '%Production'
GROUP BY j.businessUnitNormalized
```

---

## SECTION D: Validation Queries

### Query 1: Validate Job Type Distribution
```sql
SELECT
  j.jobTypeId,
  COUNT(*) as job_count,
  COUNT(DISTINCT e.id) as estimate_count
FROM `kpi-auto-471020.st_dim_v2.dim_jobs` j
LEFT JOIN `kpi-auto-471020.st_raw_v2.raw_estimates` e ON j.id = e.jobId
WHERE DATE(j.createdOn) BETWEEN '2025-08-18' AND '2025-08-24'
GROUP BY j.jobTypeId
ORDER BY estimate_count DESC
LIMIT 20;
```

### Query 2: Validate Payment Data Availability
```sql
SELECT
  DATE(p.createdOn) as payment_date,
  COUNT(*) as payment_count,
  SUM(p.amount) as total_collected
FROM `kpi-auto-471020.st_raw_v2.raw_payments` p
WHERE DATE(p.createdOn) BETWEEN '2025-08-18' AND '2025-08-24'
GROUP BY payment_date
ORDER BY payment_date;
```

---

## SECTION E: Implementation Priority

### Phase 1: Quick Wins (Can fix immediately)
1. ‚úÖ Total Booked - Already fixed
2. ‚úÖ Dollars Produced - Already fixed
3. üîß Success Rate - Change denominator to customer count
4. üîß Dollars Collected - Fix date field

### Phase 2: Requires Mapping (Need ST data)
1. üìä Job Type Mapping - Need to identify which jobTypeIds = ESTIMATE types
2. üìä Leads Filter - Need job type mapping for "contains Estimate, not COMM"
3. üìä Warranty Identification - Map warranty/touchup job types

### Phase 3: Validation Required
1. üìã GPM % - Need ST export to validate calculation method
2. üìã Future Bookings - Need date range clarification
3. üìã Outstanding A/R - Need filter criteria validation

---

## Next Steps

1. **Immediate Actions:**
   - Fix success rate calculation (customer-based denominator)
   - Fix dollars collected date field
   - Run validation queries to understand job type distribution

2. **Data Collection Needed:**
   - Export job types from ServiceTitan with names
   - Get sample ST reports for GPM%, Warranty%, A/R
   - Map jobTypeIds to categories (ESTIMATE, WARRANTY, PRODUCTION)

3. **Testing:**
   - Create test queries with fixes
   - Compare against ST exports
   - Iterate until 0% variance achieved

---

## Acceptance Criteria Status

- ‚úÖ Total Booked: 0% variance achieved
- ‚úÖ Dollars Produced: 0% variance achieved
- üî¥ Success Rate: Needs fix (customer count denominator)
- üî¥ Estimates Count: Needs job type filtering
- üî¥ Dollars Collected: Missing data/wrong date field
- ‚ö†Ô∏è Other KPIs: Need ST validation data

---

**Report Generated:** 2025-10-23
**Next Review:** After implementing Phase 1 fixes